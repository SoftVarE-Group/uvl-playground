<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" href="./uvl-icon.PNG" type="image/png">
    <link rel="stylesheet" href="./split.css">
    <link rel="stylesheet" href="./node_modules/intro.js/introjs.css">
    <link rel="stylesheet" href="./node_modules/intro.js/themes/introjs-modern.css">
    <link rel="stylesheet" href="./style.css">
    <title>UVL Playground</title>
</head>
<body>
<div class="header">
    <h1>UVL Playground</h1>
    <h2 id="connection" style="color: red;"></h2>
</div>
<div class="uvl-tutorial-button" id="uvl-tutorialButton"><div class="uvl-tutorial-button-text">?</div></div>
<div class="tutorial-button" id="tutorialButton"><div class="tutorial-button-text">?</div></div>
<div>
    <dialog id="dialog">
        <div>
            <button autofocus id="modalClose">X</button>
        </div>
        <h1>Get the UVLS VSCode Extension</h1>
        <p>You are trying to access the Configuration Page for Feature Models.
            As by now, the Web-Playground does not support this, but it is available in the VSCode Extension!
            Here is a preview:
        </p>
        <img src="https://raw.githubusercontent.com/Universal-Variability-Language/uvl-lsp/master/img/show_editor.gif"
             id="gif_in_dialog" alt="Preview">
        <p>Get the extension <a href="https://marketplace.visualstudio.com/items?itemName=caradhras.uvls-code">here</a>
        </p>
    </dialog>
</div>
<div id="main-div" style="display: flex;">
    <div id="splitter" class="splitter">
        <div id="first">
            <div id="container" class="editor"></div>
        </div>
        <div id="separator"></div>
    
        <div id="second">
            <div class="graph"></div>
        </div>
    </div>
</div>


<div class="footer">
    <p>The Universal Variability Language (UVL) is a community effort towards a widely adopted textual specification
        for feature models. This playground provides the opportunity to get used to the language with
        syntax-highlighting, autocompletion, and simple analysis. It is based on the <a
                href="https://github.com/Universal-Variability-Language/uvl-lsp">UVL Language Server</a>. To fully
        use all features use the UVLS - Universal Variability Language Server extension for visual studio code. </p>
</div>
<script type="module">
    import {startUvlClient} from "./src/main.ts";

    startUvlClient();
</script>
<script>
    // A function is used for dragging and moving
    function dragElement(element, direction) {
        var md; // remember mouse down info
        const first = document.getElementById("first");
        const second = document.getElementById("second");

        element.onmousedown = onMouseDown;

        function onMouseDown(e) {
            //console.log("mouse down: " + e.clientX);
            md = {
                e,
                offsetLeft: element.offsetLeft,
                offsetTop: element.offsetTop,
                firstWidth: first.offsetWidth,
                secondWidth: second.offsetWidth
            };

            document.onmousemove = onMouseMove;
            document.onmouseup = () => {
                //console.log("mouse up");
                document.onmousemove = document.onmouseup = null;
            }
        }

        function onMouseMove(e) {
            //console.log("mouse move: " + e.clientX);
            var delta = {
                x: e.clientX - md.e.clientX,
                y: e.clientY - md.e.clientY
            };

            if (direction === "H") // Horizontal
            {
                // Prevent negative-sized elements
                delta.x = Math.min(Math.max(delta.x, -md.firstWidth),
                    md.secondWidth);

                element.style.left = md.offsetLeft + delta.x + "px";
                first.style.width = (md.firstWidth + delta.x) + "px";
                second.style.width = (md.secondWidth - delta.x) + "px";
            }
        }
    }


    dragElement(document.getElementById("separator"), "H");
</script>
<script>
    const tutorialContent = [
        {title: "Welcome", text: "Welcome to the UVL Tutorial! All code listings will automatically be placed in the editor on the left. Click 'Next' to start the tutorial."},
        {title: "Basic Feature Model", text: "Start with the 'features' key word to start enumerating your features. Indentations matter in UVL and represent the tree structure. We will start with a basic feature model that represents a computer. Every computer needs a CPU and can optionaly have some devices connected via SATA.", 
            codeListing:
`features
    Computer
        mandatory
            CPU
        optional
            SATADevices`
        },
        {title: "Special Feature Names", text: "To use special characters or spaces in feature names use \" to enclose the names.", codeListing:
`features
    Computer
        mandatory
            CPU
        optional
            "SATA-Devices"`
        },
        {title: "Basic Constraints", text: "Use the 'constraints' keyword to start the section of constraints. In its basic form, a constraint uses propositional logic. In this example we enforce that if a computer contains a dedicated graphics card, it must also use liquid cooling. ", codeListing:
`features
    Computer
        mandatory
            CPU
            "Graphics Card"
                or
                    Dedicated
                    Integrated
            Cooling
                alternative
                    Liquid
                    Air
        optional
            "SATA-Devices"

constraints
    Dedicated => Liquid`
        },
        {title: "Feature Attributes", text: "Features can have attributes in curly brackets as key value pairs. The value can be omitted if it is a boolean attribute and the value is true. This is the case for the 'abstract' attribute in the feature 'Computer'. We also use attribues to indicate the power consumption of different parts of the computer.", codeListing:
`features
    Computer {abstract}
        mandatory
            CPU {Power 100, Manufacturer 'Intel'}
            "Graphics Card"
                or
                    Dedicated {powerConsumption 300}
                    Integrated {powerConsumption 100}
            Cooling
                alternative
                    Liquid
                    Air
        optional
            "SATA-Devices"

constraints
    Dedicated => Liquid`
        },
        {title: "Complex Constraints", text: "We can now create more complex constraints and for example access attribtues of features. In this case we use the aggregate function 'sum' to sum over all powerConsumption attributes and check if the overall powerConsumption is larger than a threshold and if so enforce a stronger power supply unit. You could also access feature attribtues and perform basic calculations with them.", codeListing:
`features
    Computer {abstract}
        mandatory
            CPU {Power 100, Manufacturer 'Intel'}
            "Graphics Card"
                or
                    Dedicated {powerConsumption 300}
                    Integrated {powerConsumption 100}
            Cooling
                alternative
                    Liquid
                    Air
            PSU
                alternative
                    StrongPSU
                    WeakPSU
        optional
            "SATA-Devices"

constraints
    Dedicated => Liquid
    sum(powerConsumption) > 300 => StrongPSU`
        },
        {title: "Group Cardinality", text: "Group cardinalities are more generic than 'or' and 'alternative'. In our example the motherboard only has space for up to 2 SATA-Devices. So we enforce that there are 0, 1, or 2 SATA-Devices.", codeListing:
`features
    Computer {abstract}
        mandatory
            CPU {Power 100, Manufacturer 'Intel'}
            "Graphics Card"
                or
                    Dedicated {powerConsumption 300}
                    Integrated {powerConsumption 100}
            Cooling
                alternative
                    Liquid
                    Air
            PSU
                alternative
                    StrongPSU
                    WeakPSU
        optional
            "SATA-Devices"
                [0..2]
                    HDD {powerConsumption 10}
                    SSD {powerConsumption 5}
                    "DVD-Drive" {powerConsumption 5}

constraints
    Dedicated => Liquid
    sum(powerConsumption) > 300 => StrongPSU`
        },
        {title: "Feature Cardinality", text: "Feature Cardinality allows a feature to be selected multiple times. In our example we can use up to 4 ram bars.", codeListing:
`features
    Computer {abstract}
        mandatory
            CPU {Power 100, Manufacturer 'Intel'}
            "Graphics Card"
                or
                    Dedicated {powerConsumption 300}
                    Integrated {powerConsumption 100}
            Cooling
                alternative
                    Liquid
                    Air
            PSU
                alternative
                    StrongPSU
                    WeakPSU
            RAM cardinality [1..4] {powerConsumption 10}
        optional
            "SATA-Devices"
                [0..2]
                    HDD {powerConsumption 10}
                    SSD {powerConsumption 5}
                    "DVD-Drive" {powerConsumption 5}

constraints
    Dedicated => Liquid
    sum(powerConsumption) > 300 => StrongPSU`
        },
        {title: "Types", text: "In UVL you can use types to create special features. In this case we change the power supply unit. It has a 'Manufacturer' feature of the type 'String' and a 'Watt' feature of the type 'Integer'. This means, when configuring the feature model, the features are not just selected or deselected, but get a value of their coresponding type. We can utilize this for even more complex constraints and check if the manufaturer of the CPU and the PSU match.", codeListing:
`features
    Computer {abstract}
        mandatory
            CPU {Power 100, Manufacturer 'Intel'}
            "Graphics Card"
                or
                    Dedicated {powerConsumption 300}
                    Integrated {powerConsumption 100}
            Cooling
                alternative
                    Liquid
                    Air
            PSU
                optional
                    String Manufacturer
                    Integer Watt
            RAM cardinality [1..4] {powerConsumption 10}
        optional
            "SATA-Devices"
                [0..2]
                    HDD {powerConsumption 10}
                    SSD {powerConsumption 5}
                    "DVD-Drive" {powerConsumption 5}

constraints
    Dedicated => Liquid
    sum(powerConsumption) < Watt
    CPU.Manufacturer == Manufacturer`
        },
        {title: "The End", text: "Now you have a basic unterstanding of the Universal Variablity Language. Go on and use the playground to test the language. If you plan on using the language more frequently we recommend installing an extension in an IDE of your choice, because it provides more features. Press the 'Done' button to close the tutorial."
        }
    ]
    let tutorialToogle = false;
    var uvlTutorialButton = document.getElementById("uvl-tutorialButton");
    uvlTutorialButton.addEventListener('click', function() {
        let tutorialPageCounter = 0;
        tutorialToogle = !tutorialToogle;
        let mainDiv = document.getElementById("main-div");
        let splitter = document.getElementsByClassName("splitter")[0];
        if(tutorialToogle){
            splitter.style.width = "75%";
            setTutorialPage(mainDiv, tutorialPageCounter);
        }else{
            splitter.style.width = "100%";
            let newDiv = document.getElementById("uvl-tutorial-div");
            mainDiv.removeChild(newDiv);
        }
    });

    function setTutorialPage(mainDiv, pageNumber){
        let tutorialDiv = document.getElementById("uvl-tutorial-div");
        if(tutorialDiv !== null){
            mainDiv.removeChild(tutorialDiv);
        }
        tutorialDiv = getTutorialPage(mainDiv, pageNumber);
        mainDiv.appendChild(tutorialDiv);
    }

    function getTutorialPage(mainDiv, pageNumber){
        const content = tutorialContent[pageNumber];
        let newDiv = document.createElement('div');
        newDiv.id = "uvl-tutorial-div";
        newDiv.style.color = "white";
        newDiv.style.position = "relative";
        newDiv.style.width = "100%";
        let headline = document.createElement('h2');
        headline.textContent = content.title;
        let text = document.createElement('div');
        text.textContent = content.text;
        text.style.lineHeight = 1.6;
        
        let navigationContainer = document.createElement('div');
        navigationContainer.style.position = "absolute";
        navigationContainer.style.bottom = 0;
        navigationContainer.style.display = "flex";
        navigationContainer.style.justifyContent = "space-between";
        navigationContainer.style.width = "90%";
        navigationContainer.style.padding = "10px";
        let backButton = document.createElement('div');
        if(pageNumber > 0){
            backButton = document.createElement('button');
            backButton.textContent = "Back";
            backButton.style.backgroundColor = "#1e1e1e";
            backButton.style.color = "#fff";
            backButton.style.border= "2px solid 'fff";
            backButton.style.borderRadius = "10%";
            backButton.style.padding = "10px 20px";
            backButton.style.cursor = "pointer";
            backButton.style.fontSize = "16px";
            backButton.onclick = () => {
                setTutorialPage(mainDiv, pageNumber - 1);
            } 
        }
        navigationContainer.appendChild(backButton);
        let nextButton = document.createElement('button');        
        nextButton.style.backgroundColor = "#1e1e1e";
        nextButton.style.color = "#fff";
        nextButton.style.border= "2px solid 'fff";
        nextButton.style.borderRadius = "10%";
        nextButton.style.padding = "10px 20px";
        nextButton.style.cursor = "pointer";
        nextButton.style.fontSize = "16px";
        if(pageNumber < tutorialContent.length - 1){
            nextButton.textContent = "Next";
            nextButton.onclick = () => {
                setTutorialPage(mainDiv, pageNumber + 1);
            } 
        }else{
            nextButton.textContent = "Done";
            nextButton.onclick = () => {
                let splitter = document.getElementsByClassName("splitter")[0];
                splitter.style.width = "100%";
                let newDiv = document.getElementById("uvl-tutorial-div");
                mainDiv.removeChild(newDiv);
                tutorialToogle = !tutorialToogle;
            } 
        }
        navigationContainer.appendChild(nextButton);
        
        newDiv.appendChild(headline);
        newDiv.appendChild(text);
        newDiv.appendChild(navigationContainer);
        const editor = window.editor;
        if(editor && content.codeListing !== undefined){
            editor.setValue(content.codeListing);
        }
        return newDiv;
    }
    
</script>
</body>
</html>
